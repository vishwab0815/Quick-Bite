name: Pull Request Checks
on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
    - name: PR Details
      run: |
        echo "ðŸ“‹ Pull Request Information"
        echo "Title: ${{ github.event.pull_request.title }}"
        echo "Author: ${{ github.event.pull_request.user.login }}"
        echo "Branch: ${{ github.head_ref }} â†’ ${{ github.base_ref }}"
        echo "Files changed: ${{ github.event.pull_request.changed_files }}"

  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR title format
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "Checking PR title: $PR_TITLE"

        # Check if title follows conventional commits (optional)
        if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?:\ .+ ]]; then
          echo "âš ï¸ PR title doesn't follow conventional commits format"
          echo "Recommended format: type(scope): description"
          echo "Examples:"
          echo "  - feat(auth): add login functionality"
          echo "  - fix(ui): resolve navbar alignment issue"
          echo "  - docs: update setup instructions"
        else
          echo "âœ… PR title follows conventional commits format"
        fi

    - name: Check for breaking changes
      run: |
        echo "ðŸ” Checking for breaking changes..."
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(models|schema|migration)"; then
          echo "âš ï¸ Database schema changes detected - ensure migration strategy is in place"
        fi

    - name: Check file sizes
      run: |
        echo "ðŸ“Š Checking for large files..."
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | xargs ls -lh 2>/dev/null | awk '$5 ~ /M/ && $5+0 > 1 {print $9 " is " $5}'; then
          echo "âš ï¸ Large files detected (>1MB)"
        else
          echo "âœ… No large files detected"
        fi

  code-review-hints:
    name: Code Review Hints
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate review checklist
      run: |
        echo "ðŸ“ Code Review Checklist:"
        echo ""
        echo "Security:"
        echo "  â–¡ No hardcoded secrets or API keys"
        echo "  â–¡ Input validation implemented"
        echo "  â–¡ Authentication/authorization checked"
        echo ""
        echo "Code Quality:"
        echo "  â–¡ Code follows project conventions"
        echo "  â–¡ No console.log in production code"
        echo "  â–¡ Error handling implemented"
        echo "  â–¡ Comments explain complex logic"
        echo ""
        echo "Testing:"
        echo "  â–¡ Tests added/updated for changes"
        echo "  â–¡ Edge cases considered"
        echo "  â–¡ Manual testing completed"
        echo ""
        echo "Documentation:"
        echo "  â–¡ README updated if needed"
        echo "  â–¡ API docs updated if endpoints changed"
        echo "  â–¡ Comments are clear and helpful"
        echo ""
        echo "Performance:"
        echo "  â–¡ No unnecessary re-renders (React)"
        echo "  â–¡ Database queries optimized"
        echo "  â–¡ No memory leaks introduced"

  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Verify Backend builds
      working-directory: ./Backend
      run: |
        npm ci
        echo "âœ… Backend dependencies installed successfully"

    - name: Verify Frontend builds
      working-directory: ./Frontend
      run: |
        npm ci
        echo "VITE_API_URL=http://localhost:3000" > .env
        npm run build
        echo "âœ… Frontend builds successfully"

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [validate-pr, code-review-hints, build-verification]
    if: always()

    steps:
    - name: Summary
      run: |
        echo "âœ… Pull Request validation completed"
        echo "ðŸ‘€ Please review the checks above before merging"
